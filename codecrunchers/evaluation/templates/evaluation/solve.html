{% extends 'www/base.html' %}

{% block content %}
    {% load staticfiles %}
    <script src="{% static 'ace/src-min/ace.js' %}" type="text/javascript" charset="utf-8"></script>
    <style type="text/css" media="screen">

        #editor {
            margin-top: 10px;
            visibility: visible;
            width: 100%;
            height: 280px;
        }

        #output {
            margin-top: 10px;
            visibility: visible;
            width: 100%;
            height: 340px;
            margin-bottom: 10px;
        }
    </style>
    <div class="col col-lg-9 col-md-9 col-sm-8 col-xs-12">
        <h2>{{ challenge.title }}
            <small> by <u>{{ challenge.creator.first_name }} {{ challenge.creator.last_name }}</u> in</small>
            <a href="{% url 'ev:topic_probs' challenge.topic.id %}"
               class="btn btn-default">{{ challenge.topic }}</a>
        </h2>
        <h5>Experience Points: {{ challenge.reward_points }}</h5>

        <div>Description:<p class="text-primary text-justify">{{ challenge.desc }}</p>
        </div>
        <div>Constraints:<p class="text-danger text-justify">{{ challenge.constraints }}</p>
        </div>
        Input Format:
        <div class="well">

            {{ challenge.input_format | linebreaks }}
        </div>
        Output Format:
        <div class="well">

            {{ challenge.output_format | linebreaks }}
        </div>
        <div class="form-group pull-right">
            <select class="form-control d-inline-block" id="lang">
                {% for lang_ob in languages %}
                    <option>{{ lang_ob.lang }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="editor">{{ challenge.startup_code }}</div>
        <br>
        <i id="loader" class="fa fa-circle-o-notch fa-spin pull-right fa-2x" aria-hidden="true"></i>
        <button class="btn btn-primary pull-left compilebutons" id="btnRun">Run
        </button>
        <button class="btn btn-success pull-right compilebutons" id="btnSubmit">Submit
        </button>

        <!-- Bootstrap cards -->
        <br><br><br><br>
        <div class="panel panel-default" id="resultCard">
            <div class="panel-heading" id="resultCardTitle">
                
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr class="active"><th id="resultCardTitleHeader">Test Cases</th><th>Status</th></tr>
                    </thead>
                    <tbody id="resultCardData">
                        
                    </tbody>
                </table>
            </div>
            <div class="panel-footer">
                <small>Built with Bootcards - Table Card</small>
            </div>
        </div>
        <!-- -->
    </div>

    <script>
        {#   Initialize the editor     #}
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/cobalt");
        editor.getSession().setTabSize(4);
        editor.getSession().setMode("ace/mode/python");
        document.getElementById('editor').style.fontSize = '15px';
        editor.getSession().setUseWrapMode(true);
        editor.setShowPrintMargin(false);

        {# Regex Function for Query String Parameters #}
        function getParameterByName(name, url) {
            if (!url) {
                url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        {#   for the output window   #}


        {#  end of output window  #}


        {#    End of editor initialization    #}

        {#    #}
        $(document).ready(function () {
            $("#loader").hide();
            $("#resultCard").hide();

            $("#btnRun").click(function () {
                $("#loader").show();
                $('#resultCard').hide();
                $(".compilebutons").hide();
                var prob_id = {{ challenge.id }};
                var code = editor.session.getValue();
                var lang = $('#lang').find(":selected").text();
                $.ajax({
                    type: "POST",
                    url: "{% url 'ev:run_testcases' %}",
                    data: {
                        "code": code,
                        "lang": lang,
                        "prob_id": prob_id,
                        "csrfmiddlewaretoken": "{{csrf_token}}",
                    },
                    success: function (data) {
                        console.log("Success");
                        console.log(data);
                        $('#resultCardTitle').html("<h3 class=\"panel-title\">Verifying with Sample Test Cases</h3>");
                        $('#resultCardTitleHeader').html("Sample Test Cases");
                        $('#resultCardData').html("");
                        var str = data.map(function(item) { 
                        var x = 0;
                        var y = 1;
                        for (var key in item)
                            while(x<1)
                            {
                                $('#resultCardData').append("<tr><td>Test Case "+parseInt(item["id"] + y)+"</td><td>"+item["status"]+"</td></tr>");
                                x = 1;
                            }
                        });
                        $('#btnSubmit').show();
                        $('#btnRun').show();
                        $('#loader').hide();
                        $("#resultCard").show();
                    },
                    error: function () {
                        output.setValue("Error:\n");
                        console.log("Error");
                        output.clearSelection();
                        $('#btnCompile').show();
                        $('#loader').hide();
                    },

                });
            });

            $("#btnSubmit").click(function () {
                $("#loader").show();
                $(".compilebutons").hide();
                $("#resultCard").hide();
                var prob_id = {{ challenge.id }};
                var code = editor.session.getValue();
                var lang = $('#lang').find(":selected").text();
                var contest_id = getParameterByName('for');

                $.ajax({
                    type: "POST",
                    url: "{% url 'ev:run_submission' %}",
                    data: {
                        "code": code,
                        "lang": lang,
                        "prob_id": prob_id,
                        "contest_id": contest_id,
                        "csrfmiddlewaretoken": "{{csrf_token}}",
                    },
                    success: function (data) {
                        console.log("Success");
                        console.log(data);
                        $('#resultCardTitle').html("<h3 class=\"panel-title\">Verifying with Test Cases</h3>");
                        $('#resultCardTitleHeader').html("Test Cases");
                        $('#resultCardData').html("");
                        var str = data.map(function(item) { 
                        var x = 0;
                        var y = 1;
                        for (var key in item)
                            while(x<1)
                            {
                                $('#resultCardData').append("<tr><td>Test Case "+parseInt(item["id"] + y)+"</td><td>"+item["status"]+"</td></tr>");
                                x = 1;
                            }
                        });
                        $('#btnSubmit').show();
                        $('#btnRun').show();
                        $('#loader').hide();
                        $("#resultCard").show();
                    },
                    error: function () {
                        console.log("Error");
                        $('.compilebutons').show();
                        $('#loader').hide();
                    },

                });

            });

            {#        Code to change console highlighting    #}
            $('#lang').on('change', function (e) {
                var editor = ace.edit('editor');
                var lang = $('#lang').find(":selected").text();
                $.ajax({
                    type: "POST",
                    url: "{% url 'cc:get_ace_name' %}",
                    data: {
                        "lang": lang,
                        "csrfmiddlewaretoken": "{{csrf_token}}",
                    },
                    success: function (data) {
                        console.log("Success");
                        console.log(data);
                        lang = data;
                        editor.getSession().setMode("ace/mode/" + lang);
                    },
                    error: function (data) {
                        console.log("Error");
                        console.log(data);

                    },

                });
            });
            {#      End of language switch      #}

        });
    </script>
{% endblock %}